<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/manager/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="FilesystemRepositoryManager.html">FilesystemRepositoryManager</a><ul class='methods'><li data-type='method'><a href="FilesystemRepositoryManager.html#.addRepository">addRepository</a></li><li data-type='method'><a href="FilesystemRepositoryManager.html#.createRepository">createRepository</a></li><li data-type='method'><a href="FilesystemRepositoryManager.html#.exists">exists</a></li><li data-type='method'><a href="FilesystemRepositoryManager.html#.get_sub_directories">get_sub_directories</a></li><li data-type='method'><a href="FilesystemRepositoryManager.html#.scan">scan</a></li><li data-type='method'><a href="FilesystemRepositoryManager.html#.scanAll">scanAll</a></li></ul></li><li><a href="GitRepositoryManager.html">GitRepositoryManager</a><ul class='methods'><li data-type='method'><a href="GitRepositoryManager.html#.addRepository">addRepository</a></li><li data-type='method'><a href="GitRepositoryManager.html#.checkoutBranch">checkoutBranch</a></li><li data-type='method'><a href="GitRepositoryManager.html#.createRepository">createRepository</a></li><li data-type='method'><a href="GitRepositoryManager.html#.exists">exists</a></li><li data-type='method'><a href="GitRepositoryManager.html#.get_sub_directories">get_sub_directories</a></li><li data-type='method'><a href="GitRepositoryManager.html#.getBranches">getBranches</a></li><li data-type='method'><a href="GitRepositoryManager.html#.getCurrentBranch">getCurrentBranch</a></li><li data-type='method'><a href="GitRepositoryManager.html#.isGitRepository">isGitRepository</a></li><li data-type='method'><a href="GitRepositoryManager.html#.mergeBranches">mergeBranches</a></li><li data-type='method'><a href="GitRepositoryManager.html#.mergeBranches">mergeBranches</a></li><li data-type='method'><a href="GitRepositoryManager.html#.scan">scan</a></li><li data-type='method'><a href="GitRepositoryManager.html#.scanAll">scanAll</a></li><li data-type='method'><a href="GitRepositoryManager.html#.update">update</a></li></ul></li><li><a href="MediaRepositoryManager.html">MediaRepositoryManager</a><ul class='methods'><li data-type='method'><a href="MediaRepositoryManager.html#.exists">exists</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.fetchCoreRepository">fetchCoreRepository</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.getRepositoriesNode">getRepositoriesNode</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.getRepositoryNames">getRepositoryNames</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.getRepositoryPath">getRepositoryPath</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.getType">getType</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.remove">remove</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.scanAll">scanAll</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.scanAll">scanAll</a></li><li data-type='method'><a href="MediaRepositoryManager.html#.update">update</a></li></ul></li><li><a href="module-connector-Connector.html">Connector</a><ul class='methods'><li data-type='method'><a href="module-connector-Connector.html#connect">connect</a></li><li data-type='method'><a href="module-connector-Connector.html#getDataType">getDataType</a></li><li data-type='method'><a href="module-connector-Connector.html#getId">getId</a></li><li data-type='method'><a href="module-connector-Connector.html#getPath">getPath</a></li><li data-type='method'><a href="module-connector-Connector.html#getProtoKey">getProtoKey</a></li></ul></li><li><a href="Node.html">Node</a><ul class='methods'><li data-type='method'><a href="Node.html#.addChild">addChild</a></li><li data-type='method'><a href="Node.html#.addNode">addNode</a></li><li data-type='method'><a href="Node.html#.firstChild">firstChild</a></li><li data-type='method'><a href="Node.html#.get">get</a></li><li data-type='method'><a href="Node.html#.getChild">getChild</a></li><li data-type='method'><a href="Node.html#.getChildNames">getChildNames</a></li><li data-type='method'><a href="Node.html#.getOrCreateNode">getOrCreateNode</a></li><li data-type='method'><a href="Node.html#.getParent">getParent</a></li><li data-type='method'><a href="Node.html#.getPath">getPath</a></li><li data-type='method'><a href="Node.html#.getRoot">getRoot</a></li><li data-type='method'><a href="Node.html#.hasChild">hasChild</a></li><li data-type='method'><a href="Node.html#.removeChild">removeChild</a></li><li data-type='method'><a href="Node.html#.set">set</a></li><li data-type='method'><a href="Node.html#.toString">toString</a></li></ul></li><li><a href="Root.html">Root</a><ul class='methods'><li data-type='method'><a href="Root.html#.createRecursive">createRecursive</a></li><li data-type='method'><a href="Root.html#.findNode">findNode</a></li><li data-type='method'><a href="Root.html#contains">contains</a></li></ul></li><li><a href="TextureManager.html">TextureManager</a><ul class='methods'><li data-type='method'><a href="TextureManager.html#scan">scan</a></li></ul></li><li><a href="TreeClient.html">TreeClient</a><ul class='methods'><li data-type='method'><a href="TreeClient.html#branchMediaRepository">branchMediaRepository</a></li><li data-type='method'><a href="TreeClient.html#callEndpoint">callEndpoint</a></li><li data-type='method'><a href="TreeClient.html#clientWindowFullscreen">clientWindowFullscreen</a></li><li data-type='method'><a href="TreeClient.html#clientWindowMaximize">clientWindowMaximize</a></li><li data-type='method'><a href="TreeClient.html#clientWindowMinimize">clientWindowMinimize</a></li><li data-type='method'><a href="TreeClient.html#clientWindowRestore">clientWindowRestore</a></li><li data-type='method'><a href="TreeClient.html#connectInstance">connectInstance</a></li><li data-type='method'><a href="TreeClient.html#createEndpoint">createEndpoint</a></li><li data-type='method'><a href="TreeClient.html#createInstance">createInstance</a></li><li data-type='method'><a href="TreeClient.html#createMediaRepository">createMediaRepository</a></li><li data-type='method'><a href="TreeClient.html#getAllInstances">getAllInstances</a></li><li data-type='method'><a href="TreeClient.html#getEndpointUrl">getEndpointUrl</a></li><li data-type='method'><a href="TreeClient.html#getInstance">getInstance</a></li><li data-type='method'><a href="TreeClient.html#readHJsonConfig">readHJsonConfig</a></li><li data-type='method'><a href="TreeClient.html#readTOMLConfig">readTOMLConfig</a></li><li data-type='method'><a href="TreeClient.html#removeInstance">removeInstance</a></li><li data-type='method'><a href="TreeClient.html#removeMediaRepository">removeMediaRepository</a></li><li data-type='method'><a href="TreeClient.html#scanMediaRepositories">scanMediaRepositories</a></li><li data-type='method'><a href="TreeClient.html#shutdownFlex">shutdownFlex</a></li><li data-type='method'><a href="TreeClient.html#startAllInstances">startAllInstances</a></li><li data-type='method'><a href="TreeClient.html#startInstance">startInstance</a></li><li data-type='method'><a href="TreeClient.html#stopAllInstances">stopAllInstances</a></li><li data-type='method'><a href="TreeClient.html#stopInstance">stopInstance</a></li><li data-type='method'><a href="TreeClient.html#synchronizeInstance">synchronizeInstance</a></li><li data-type='method'><a href="TreeClient.html#updateMediaRepository">updateMediaRepository</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="api%250AThe%2520RESTful%2520API%2520that%2520drives%2520flex.%250A%250ATODO_%2520swagger%2520documentation,%2520see%2520https___www.npmjs.com_package_swagger-jsdocmodule_.html">api
The RESTful API that drives flex.

TODO: swagger documentation, see https://www.npmjs.com/package/swagger-jsdoc</a></li><li><a href="context%250AProvides%2520an%2520application%2520context.module_.html">context
Provides an application context.</a></li><li><a href="media%250AProvides%2520media%2520management%2520functionalities.module_.html">media
Provides media management functionalities.</a></li><li><a href="module-connector.html">connector</a></li><li><a href="module-inexor-plugins_hjsonreader.html">inexor-plugins/hjsonreader</a></li><li><a href="module-inexor-plugins_tomlreader.html">inexor-plugins/tomlreader</a><ul class='methods'><li data-type='method'><a href="module-inexor-plugins_tomlreader.html#~isInMediaOrConfigDirectory">isInMediaOrConfigDirectory</a></li><li data-type='method'><a href="module-inexor-plugins_tomlreader.html#~readConfigFile">readConfigFile</a></li><li data-type='method'><a href="module-inexor-plugins_tomlreader.html#~withinDirectory">withinDirectory</a></li></ul></li><li><a href="module-manager.html">manager</a><ul class='methods'><li data-type='method'><a href="module-manager.html#~create">create</a></li><li data-type='method'><a href="module-manager.html#~start">start</a></li><li data-type='method'><a href="module-manager.html#~stop">stop</a></li></ul></li><li><a href="path%250A__%2520TODO_%2520Might%2520be%2520better%2520called%2520inexor-game_defaultsmodule_.html">path
// TODO: Might be better called inexor-game/defaults</a><ul class='methods'><li data-type='method'><a href="path%25250A__%252520TODO_%252520Might%252520be%252520better%252520called%252520inexor-game_defaultsmodule_.html#~getBasePath">getBasePath</a></li><li data-type='method'><a href="path%25250A__%252520TODO_%252520Might%252520be%252520better%252520called%252520inexor-game_defaultsmodule_.html#~getConfigPaths">getConfigPaths</a></li><li data-type='method'><a href="path%25250A__%252520TODO_%252520Might%252520be%252520better%252520called%252520inexor-game_defaultsmodule_.html#~getMediaPaths">getMediaPaths</a></li></ul></li><li><a href="tree%250AProvides%2520generic%2520methods%2520to%2520work%2520treesmodule_.html">tree
Provides generic methods to work trees</a></li><li><a href="treeclient%250AProvides%2520a%2520client%2520for%2520accessing%2520a%2520local%2520or%2520remote%2520Inexor%2520Tree%2520via%2520REST%2520API.module_.html">treeclient
Provides a client for accessing a local or remote Inexor Tree via REST API.</a></li><li><a href="types%250AConverts%2520Core%2520types%2520to%2520JavaScript%250ANOTE_%2520Requires%2520--harmony%2520flag%2520on%2520Node%2520_%25207.2.1module_.html">types
Converts Core types to JavaScript
NOTE: Requires --harmony flag on Node < 7.2.1</a><ul class='methods'><li data-type='method'><a href="types%25250AConverts%252520Core%252520types%252520to%252520JavaScript%25250ANOTE_%252520Requires%252520--harmony%252520flag%252520on%252520Node%252520_%2525207.2.1module_.html#~getDataType">getDataType</a></li><li data-type='method'><a href="types%25250AConverts%252520Core%252520types%252520to%252520JavaScript%25250ANOTE_%252520Requires%252520--harmony%252520flag%252520on%252520Node%252520_%2525207.2.1module_.html#~isInt">isInt</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#isValidDataType">isValidDataType</a></li><li><a href="global.html#media_types">media_types</a></li><li><a href="global.html#repository_types">repository_types</a></li><li><a href="global.html#separator">separator</a></li><li><a href="global.html#validName">validName</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/manager/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Is responsible for starting and handling of Inexor Core instances.
 * @module manager
 */

const path = require('path');
const fs = require('fs');
const spawn = require('child_process').spawn;
const portastic = require('portastic');
const util = require('util');
const debuglog = util.debuglog('manager');
const tree = require('@inexor-game/tree');
const inexor_path = require('@inexor-game/path');

// The default port to use
const defaultPort = 31415;

/**
 * An Inexor Core instance defines the meta information about an client or server instance.
 * @typedef {Object} instance
 * @property {number} id - the instance identifier
 * @property {string} args - the command line arguments to supply to Inexor Core
 * @property {tree.Root} tree - the tree associated with the instance
 */

/**
 * Creates an instance of Inexor Core. The instance is created but not started!
 * @function
 * @param {string} args
 * @param {number} [identifier] - the instance identifier
 * @param {number} [port] - the port to bind to
 * @param {tree.Root} [t] - the configuration tree
 * @return {Promise&lt;manager.instance>}
 */
function create(args, identifier = null, port = null, t = null) {
  return new Promise((resolve, reject) => {
    let instance = {};
    instance.args = args;

  	// Either use the given Inexor Tree or create a new tree for this
    // instance of Inexor Core.
    instance.tree = t; // Is null if no tree is specified
    if (t == null) {
      instance.tree = new tree.Node(null, '/', 'node');
    }

    /**
     * @private
     * Reduce DRY code
     */
    let resolvePort = function(port) {
      portastic.test(_port).then((isOpen) => {
        if (isOpen) {
          instance.id = identifier;
          instance.port = _port;
          debuglog('Creating instance ' + identifier + ' on port ' + _port);
          resolve(instance);
        } else {
          throw new Error('EADDRINUSE, Address already in use.');
        }
      })
    }

    // Resolve the port
    let _port = null;
    // TODO: might need moarr asynchronisation
    if (port == null &amp;&amp; identifier == null) {
      try {
        portastic.find({min: defaultPort, max: defaultPort + 1000}).then((ports) => {
          if (array.length &lt; 0) {
          	debuglog('No open port found');
            throw new Error('No open port found'); // This should never happen, honestly.
          } else {
            identifier = ports[0];
            _port = identifier;
            resolvePort(_port);
          }
        })
      } catch (e) {
        throw new Error('Failed to find an open port: ' + e.message);
      }
    } else if (port == null &amp;&amp; identifier != null) {
      _port = identifier;
    } else {
      _port = port;
    }

    resolvePort(_port);
  })
}

function get_sub_directories(_path) {
  return fs.readdirSync(_path).filter(function(file) {
    return fs.statSync(path.join(_path, file)).isDirectory();
  });
}

/**
 * Starts an instance and returns the instance with a child_process attached
 * @function
 * @param {manager.instance}
 * @return {Promise&lt;instance>}
 */
function start(instance) {
	debuglog('Starting instance ' + instance.id);

  return new Promise((resolve, reject) => {
  	try {
  	  // let flex_dir = process.cwd();
      // let flex_dir = path.join(__dirname, '../../..');
			// let flex_dir = path.resolve('.');
			// log.info('flex_dir = ' + path.resolve(flex_dir));

      debuglog('flex_path = ' + inexor_path.flex_path);
      let base_path = inexor_path.get_base_path();
  	  debuglog('base_path = ' + path.resolve(base_path));
      let binary_path = path.join(base_path, inexor_path.binary_path);
      debuglog('binary_path = ' + path.resolve(binary_path));
      let media_path = path.join(base_path, inexor_path.media_path);
      debuglog('media_path = ' + path.resolve(media_path));
      let media_repositories = get_sub_directories(media_path);
      let args = [];
      args.push('-q~/.inexor');
      if (instance.args.length > 0) {
        args.push(instance.args);
      }
      // args.push('-k' + path.resolve(media_path));
      media_repositories.forEach(function(media_repository) {
        var media_dir = path.join(media_path, media_repository);
        // args.push('-k' + path.resolve(media_dir));
        args.push('-k./media/' + media_repository);
      });
      let options = {
        cwd: path.resolve(base_path)
      };
      debuglog(args);
      debuglog('Starting ' + binary_path + ' ' + args.join(' '));
      instance._process = spawn(binary_path, args, options);
      instance._process.on('error', (err) => {
      	debuglog('Error on instance ' + instance.id + ': ' + err.message);
        throw new Error(err); // This should be instantly fired
      });
      instance._process.stdout.on('data', function(data) {
        debuglog(String(data));
      });
      instance._process.stderr.on('data', function(data) {
        debuglog(String(data));
      });
      instance._process.on('exit', function(code) {
        debuglog('child process exited with code ' + String(code));
      });
  	} catch (err) {
  		debuglog(err.message);
  		throw new Error(err);
  	}
    resolve(instance);
  })
}

/**
 * Stops an instance
 * @function
 * @param {manager.instance}
 * @return {Promise&lt;bool>}
 */
function stop(instance) {
	debuglog('Stopping instance ' + instance.id);
  return new Promise((resolve, reject) => {
    instance._process.on('close', (code, signal) => {
      resolve(`Child process terminated due to receipt of signal ${signal}`)
    })
    instance._process.on('error', (err) => {
      throw new Error(err);
    })

    instance._process.kill(); // SIGTERM
  })
}

module.exports = {
  create: create,
  start: start,
  stop: stop
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu Jan 19 2017 23:51:57 GMT+0100 (CET) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
